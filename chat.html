import { db, auth } from "./firebase.js";
import {
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("msgInput");
const btn = document.getElementById("sendBtn");

// ðŸ‘‡ replace with real UID of second user
const OTHER_USER_UID = "PASTE_OTHER_USER_UID_HERE";

function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join("_");
}

onAuthStateChanged(auth, user => {
  if (!user) return;

  const myUid = user.uid;
  const chatId = getChatId(myUid, OTHER_USER_UID);

  const msgsRef = collection(db, "chats", chatId, "messages");
  const q = query(msgsRef, orderBy("time"));

  // LISTEN FOR MESSAGES
  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const p = document.createElement("p");

      p.textContent = data.text;
      p.style.textAlign = data.from === myUid ? "right" : "left";

      messagesDiv.appendChild(p);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // SEND MESSAGE
  btn.addEventListener("click", async () => {
    if (input.value.trim() === "") return;

    await addDoc(msgsRef, {
      text: input.value,
      from: myUid,
      to: OTHER_USER_UID,
      time: Date.now()
    });

    input.value = "";
  });
});



